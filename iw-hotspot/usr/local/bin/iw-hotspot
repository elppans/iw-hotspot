#!/bin/bash

# Nome do comando/script
command="$(basename "$0")"

# Diretório de log
log_dir="/tmp"
mkdir -p "$log_dir"

# Arquivos de log
timestamp="$(date +'%Y%m%d_%H%M%S')"
log_file="${log_dir}/${command}_${timestamp}.log"
log_error="${log_dir}/${command}_${timestamp}_error.log"

# Garantir arquivos e permissão
touch "$log_file" "$log_error"
chmod 644 "$log_file" "$log_error"

# Redirecionamento de saída
exec > >(tee -a "$log_file") 2> >(tee -a "$log_error" >&2)

# Função para log com timestamp
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
}

# Verificação de permissões
if [[ $EUID -ne 0 ]]; then
    log "Este script precisa ser executado como root."
    exit 1
fi

# Mensagem inicial
log "Iniciando script: $command"
log "Log de saída: $log_file"
log "Log de erro: $log_error"

export elan="enp4s0"
export wlan="wlp5s0"
export vlan="ap0"

iw list | grep -A 10 "Supported interface modes" ;
iw dev "$vlan" del &>>/dev/null
sleep 2
iw dev "$wlan" interface add "$vlan" type __ap ;
sleep 2
ip addr add 192.168.150.1/24 dev "$vlan" ;
sleep 2
ip link set "$vlan" up ;

# elan wlan
iptables -t nat -A POSTROUTING -o "$wlan" -j MASQUERADE ;
iptables -A FORWARD -i "$elan" -o "$wlan" -j ACCEPT ;
iptables -A FORWARD -i "$wlan" -o "$elan" -m state --state RELATED,ESTABLISHED -j ACCEPT ;

# wlan vlan
iptables -t nat -A POSTROUTING -o "$wlan" -j MASQUERADE ;
iptables -A FORWARD -i "$vlan" -o "$wlan" -j ACCEPT ;
iptables -A FORWARD -i "$wlan" -o "$vlan" -m state --state RELATED,ESTABLISHED -j ACCEPT ;

# elan vlan
iptables -t nat -A POSTROUTING -o "$elan" -j MASQUERADE ;
iptables -A FORWARD -i "$vlan" -o "$elan" -j ACCEPT ;
iptables -A FORWARD -i "$elan" -o "$vlan" -m state --state RELATED,ESTABLISHED -j ACCEPT ;

echo 1 | tee /proc/sys/net/ipv4/ip_forward
sysctl -w net.ipv4.ip_forward=1 ;

# Desbloquear placas Wi-Fi
rfkill unblock wifi
rfkill unblock all

# sudo systemctl unmask hostapd # Se estiver mascarado
# systemctl stop hostapd ; sleep 2
# systemctl start hostapd ; sleep 2
# sudo systemctl status hostapd | cat

# systemctl stop dnsmasq ; sleep 2
# systemctl start dnsmasq ; sleep 2
# sudo systemctl status dnsmasq | cat

# Anotações
# https://github.com/elppans/doc-linux/blob/main/ubuntu_criar_interface_de_rede.md

# Verificar status

# iw (interface wireless)
log "Escaneando redes Wi-Fi..."
iw dev                        # Verificar interfaces
iw dev "$wlan" link             # Mostra detalhes da conexão atual
iw dev "$wlan" scan             # Escaneia redes disponíveis (bem detalhado)
iw list                       # Lista capacidades do driver (muito verboso por padrão)
iw list | grep -A 20 "Frequencies" # Lista frequencias suportadas (2,5 GHz e 5 GHz)

rfkill list                   # Lista dispositivos bloqueados/desbloqueados

# ip (configuração de rede)
log "Verificando interfaces de rede..."
ip -s addr show               # Mostra estatísticas de pacotes por interface
ip -s link show               # Detalhes da camada de enlace

# iptables (firewall)
log "Regras de firewall:"
iptables -L -v -n        # -v para verbose, -n para evitar resolução de nomes
iptables -S              # Lista regras como comandos

# sysctl (parâmetros do kernel)
log "Parâmetros do kernel:"
# sysctl -a                     # Mostra todos os parâmetros e seus valores
sysctl net.ipv4.ip_forward    # Mostra um parâmetro especifico

log "Script finalizado com sucesso."
